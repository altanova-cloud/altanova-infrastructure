# -------------------------
# SHARED ACCOUNT PIPELINE
# -------------------------
# This pipeline manages the foundational infrastructure in the shared account:
# - IAM roles (GitLabRunnerRole, TerraformStateAccessRole)
# - S3 state bucket
# - DynamoDB lock table
# - GitLab OIDC provider
#
# IMPORTANT: This pipeline only runs when shared-account files change
# to prevent unnecessary runs and reduce risk to backend infrastructure.

# -------------------------
# VALIDATION JOBS
# -------------------------
shared-fmt:
  extends: .terraform
  stage: validate
  variables:
    ENV_DIR: shared-account
  script:
    - terraform fmt -check -recursive
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - aws/environments/shared-account/**/*
        - aws/modules/bootstrap/**/*
      when: always
    - if: $CI_COMMIT_BRANCH == "master"
      changes:
        - aws/environments/shared-account/**/*
        - aws/modules/bootstrap/**/*
      when: always

shared-lint:
  stage: validate
  image: ghcr.io/terraform-linters/tflint
  variables:
    ENV_DIR: shared-account
  script:
    - cd ${TF_ROOT}/${ENV_DIR}
    - tflint --recursive
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - aws/environments/shared-account/**/*
        - aws/modules/bootstrap/**/*
      when: always
    - if: $CI_COMMIT_BRANCH == "master"
      changes:
        - aws/environments/shared-account/**/*
        - aws/modules/bootstrap/**/*
      when: always

shared-validate:
  extends: .terraform
  stage: validate
  variables:
    ENV_DIR: shared-account
  needs:
    - shared-fmt
    - shared-lint
  script:
    - terraform validate
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - aws/environments/shared-account/**/*
        - aws/modules/bootstrap/**/*
      when: always
    - if: $CI_COMMIT_BRANCH == "master"
      changes:
        - aws/environments/shared-account/**/*
        - aws/modules/bootstrap/**/*
      when: always

# -------------------------
# PLAN JOB
# -------------------------
shared-plan:
  extends: .plan_template
  variables:
    ENV_DIR: shared-account
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - aws/environments/shared-account/**/*
        - aws/modules/bootstrap/**/*
      when: always
    - if: $CI_COMMIT_BRANCH == "master"
      changes:
        - aws/environments/shared-account/**/*
        - aws/modules/bootstrap/**/*
      when: always

# -------------------------
# APPROVE JOB
# -------------------------
shared-approve:
  extends: .approve_template
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - aws/environments/shared-account/**/*
        - aws/modules/bootstrap/**/*
      when: manual
    - if: $CI_COMMIT_BRANCH == "master"
      changes:
        - aws/environments/shared-account/**/*
        - aws/modules/bootstrap/**/*
      when: manual
  variables:
    ENV_DIR: shared-account
  needs: [shared-plan]

# -------------------------
# APPLY JOB
# -------------------------
shared-apply:
  extends: .terraform
  stage: apply
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - aws/environments/shared-account/**/*
        - aws/modules/bootstrap/**/*
      when: manual
    - if: $CI_COMMIT_BRANCH == "master"
      changes:
        - aws/environments/shared-account/**/*
        - aws/modules/bootstrap/**/*
      when: manual
  variables:
    ENV_DIR: shared-account
  needs: [shared-plan, shared-approve]
  script:
    - terraform apply -auto-approve tfplan
