# -------------------------
# AWS OIDC AUTH TEMPLATE
# -------------------------
.aws_auth_script: &aws_auth_script
  - apk add --no-cache aws-cli jq
  - >
    aws_sts_output=$(aws sts assume-role-with-web-identity \
      --role-arn "${AWS_ROLE_ARN}" \
      --role-session-name "GitLabRunner-${CI_PROJECT_ID}-${CI_PIPELINE_ID}" \
      --web-identity-token "${GITLAB_OIDC_TOKEN}" \
      --duration-seconds 3600 \
      --query 'Credentials.[AccessKeyId,SecretAccessKey,SessionToken]' \
      --output text)
  - export $(printf "AWS_ACCESS_KEY_ID=%s AWS_SECRET_ACCESS_KEY=%s AWS_SESSION_TOKEN=%s" $aws_sts_output)


# -------------------------
# TERRAFORM TEMPLATE
# -------------------------
.terraform:
  image:
    name: hashicorp/terraform:1.8
    entrypoint: [""]
  cache:
    key: "${CI_COMMIT_REF_SLUG}-${ENV_DIR}"
    paths:
      - aws/environments/${ENV_DIR}/.terraform.lock.hcl   # KEEP ONLY LOCK FILE
  id_tokens:
    GITLAB_OIDC_TOKEN:
      aud: https://gitlab.com
  before_script:
    - export TF_ROOT="${CI_PROJECT_DIR}/aws/environments"
    - *aws_auth_script
    - cd ${TF_ROOT}/${ENV_DIR}
    - |
      if [ -f backend.conf ]; then
        terraform init -backend-config=backend.conf -reconfigure
      else
        terraform init -reconfigure
      fi


# -------------------------
# TERRAFORM DEPLOY ROLE TEMPLATE
# -------------------------
.assume_deploy_role:
  extends: .terraform
  before_script:
    - export TF_ROOT="${CI_PROJECT_DIR}/aws/environments"
    - *aws_auth_script  # Get initial OIDC credentials
    - |
      if [ -n "$DEPLOY_ROLE_ARN" ]; then
        echo "Assuming deploy role: $DEPLOY_ROLE_ARN"
        deploy_creds=$(aws sts assume-role \
          --role-arn "$DEPLOY_ROLE_ARN" \
          --role-session-name "Deploy-${ENV_DIR}-${CI_PIPELINE_ID}" \
          --duration-seconds 3600 \
          --query 'Credentials.[AccessKeyId,SecretAccessKey,SessionToken]' \
          --output text)
        export $(printf "AWS_ACCESS_KEY_ID=%s AWS_SECRET_ACCESS_KEY=%s AWS_SESSION_TOKEN=%s" $deploy_creds)
      fi
    - cd ${TF_ROOT}/${ENV_DIR}
    - |
      if [ -f backend.conf ]; then
        terraform init -backend-config=backend.conf -reconfigure
      else
        terraform init -reconfigure
      fi

# -------------------------
# PLAN JOB (matrix)
# -------------------------
.plan_template:
  extends: .terraform
  stage: plan
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: always
    - if: $CI_COMMIT_BRANCH == "master"
      when: always
  script:
    - terraform plan -out=tfplan | tee plan.txt
    - terraform show -no-color tfplan > plan-readable.txt
  artifacts:
    paths:
      - aws/environments/*/tfplan
      - aws/environments/*/plan-readable.txt
    expire_in: 7 days

# -------------------------
# APPROVE TEMPLATE
# -------------------------
.approve_template:
  stage: approve
  rules:
    - if: $CI_COMMIT_BRANCH == "master"
      when: manual
  script:
    - export TF_ROOT="${CI_PROJECT_DIR}/aws/environments"
    - echo "Reviewing plan for ${ENV_DIR}"
    - cd ${TF_ROOT}/${ENV_DIR}
    - cat plan-readable.txt || echo "No plan found"

# -------------------------
# APPLY TEMPLATE
# -------------------------
.apply_template:
  extends: .assume_deploy_role
  stage: apply
  rules:
    - if: $CI_COMMIT_BRANCH == "master"
      when: manual
  script:
    - terraform apply -auto-approve tfplan
