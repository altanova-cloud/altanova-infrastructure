stages:
  - security
  - validate
  - plan
  - cost
  - approve
  - apply

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: always
    - if: $CI_COMMIT_BRANCH == "master"
      when: always
    - when: never

include:
  - local: ".gitlab/ci/security.yml"
  - local: ".gitlab/ci/templates.yml"


# -------------------------
# SHARED INFRASTRUCTURE PIPELINE (Child)
# -------------------------
shared-infra-pipeline:
  stage: plan
  trigger:
    include: .gitlab/ci/shared-account.yml
    strategy: depend
  needs: []
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - aws/environments/shared-account/**/*
        - aws/modules/bootstrap/**/*
    - if: $CI_COMMIT_BRANCH == "master"
      changes:
        - aws/environments/shared-account/**/*
        - aws/modules/bootstrap/**/*


# -------------------------
# VALIDATION JOBS (fmt, lint, validate)
# -------------------------
fmt:
  extends: .terraform
  stage: validate
  script:
    - terraform fmt -check -recursive
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: always
  parallel:
    matrix:
      - ENV_DIR: [dev-app-account, prod-app-account]

lint:
  stage: validate
  image: ghcr.io/terraform-linters/tflint
  script:
    - cd ${TF_ROOT}/${ENV_DIR}
    - tflint --recursive
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: always
  parallel:
    matrix:
      - ENV_DIR: [dev-app-account, prod-app-account]

validate:
  extends: .terraform
  stage: validate
  needs:
    - fmt
    - lint
  script:
    - terraform validate
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: always
  parallel:
    matrix:
      - ENV_DIR: [dev-app-account, prod-app-account]


# -------------------------
# PLAN JOB (matrix)
# -------------------------


dev-plan:
  extends: .assume_deploy_role
  stage: plan
  variables:
    ENV_DIR: dev-app-account
    DEPLOY_ROLE_ARN: $DEV_DEPLOY_ROLE_ARN
  script:
    - terraform plan -out=tfplan | tee plan.txt
    - terraform show -no-color tfplan > plan-readable.txt

prod-plan:
  extends: .assume_deploy_role
  stage: plan
  variables:
    ENV_DIR: prod-app-account
    DEPLOY_ROLE_ARN: $PROD_DEPLOY_ROLE_ARN
  script:
    - terraform plan -out=tfplan | tee plan.txt
    - terraform show -no-color tfplan > plan-readable.txt


# -------------------------
# COST ESTIMATION (Infracost)
# -------------------------
infracost:
  stage: cost
  image:
    name: infracost/infracost:latest
    entrypoint: [""]
  allow_failure: true
  parallel:
    matrix:
      - ENV_DIR: [dev-app-account, prod-app-account]
  script:
    - cd ${TF_ROOT}/${ENV_DIR}
    - infracost breakdown --path . --format json --out-file infracost.json
  artifacts:
    paths:
      - aws/environments/*/infracost.json
    expire_in: 30 days
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: always


# -------------------------
# APPROVE + APPLY
# -------------------------


dev-approve:
  extends: .approve_template
  variables:
    ENV_DIR: dev-app-account
  needs: [dev-plan]

prod-approve:
  extends: .approve_template
  variables:
    ENV_DIR: prod-app-account
  needs: [prod-plan]



dev-apply:
  extends: .apply_template
  variables:
    ENV_DIR: dev-app-account
    DEPLOY_ROLE_ARN: $DEV_DEPLOY_ROLE_ARN
  needs: [dev-plan, dev-approve]

prod-apply:
  extends: .apply_template
  variables:
    ENV_DIR: prod-app-account
    DEPLOY_ROLE_ARN: $PROD_DEPLOY_ROLE_ARN
  needs: [prod-plan, prod-approve]
  