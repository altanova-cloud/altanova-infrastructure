# Security Scanning Reusable Workflow
# Phase 2: TFLint, Checkov, TFSec scanning with soft-fail mode
#
# HOW TO DISABLE:
# Set repository variable ENABLE_SECURITY_SCANNING = 'false'
# Or comment out the security-scan job in the caller workflow

name: Security Scan (Reusable)

on:
  workflow_call:
    inputs:
      working_directory:
        description: 'Terraform working directory (e.g., aws/environments/shared-account)'
        required: true
        type: string
      terraform_version:
        description: 'Terraform version for init'
        required: false
        type: string
        default: '1.8'
      environment_name:
        description: 'Environment name for artifact naming (shared, dev, prod)'
        required: true
        type: string
      artifact_retention_days:
        description: 'Artifact retention in days (SOC 2: 90+)'
        required: false
        type: number
        default: 90
      fail_on_findings:
        description: 'Whether to fail the workflow on security findings'
        required: false
        type: boolean
        default: false
    outputs:
      tflint_status:
        description: 'TFLint scan status (success/failure)'
        value: ${{ jobs.scan.outputs.tflint_status }}
      checkov_status:
        description: 'Checkov scan status (success/failure)'
        value: ${{ jobs.scan.outputs.checkov_status }}
      tfsec_status:
        description: 'TFSec scan status (success/failure)'
        value: ${{ jobs.scan.outputs.tfsec_status }}
      tflint_findings:
        description: 'Number of TFLint findings'
        value: ${{ jobs.scan.outputs.tflint_findings }}
      checkov_passed:
        description: 'Number of Checkov checks passed'
        value: ${{ jobs.scan.outputs.checkov_passed }}
      checkov_failed:
        description: 'Number of Checkov checks failed'
        value: ${{ jobs.scan.outputs.checkov_failed }}
      checkov_skipped:
        description: 'Number of Checkov checks skipped'
        value: ${{ jobs.scan.outputs.checkov_skipped }}
      tfsec_findings:
        description: 'Number of TFSec findings'
        value: ${{ jobs.scan.outputs.tfsec_findings }}

jobs:
  scan:
    name: Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15

    outputs:
      tflint_status: ${{ steps.tflint.outcome }}
      checkov_status: ${{ steps.checkov.outcome }}
      tfsec_status: ${{ steps.tfsec.outcome }}
      tflint_findings: ${{ steps.parse-tflint.outputs.findings }}
      checkov_passed: ${{ steps.parse-checkov.outputs.passed }}
      checkov_failed: ${{ steps.parse-checkov.outputs.failed }}
      checkov_skipped: ${{ steps.parse-checkov.outputs.skipped }}
      tfsec_findings: ${{ steps.parse-tfsec.outputs.findings }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ inputs.terraform_version }}

      # ========================================
      # TFLint Setup and Execution
      # ========================================
      - name: Cache TFLint plugins
        uses: actions/cache@v4
        with:
          path: ~/.tflint.d/plugins
          key: tflint-${{ runner.os }}-${{ hashFiles('.tflint.hcl') }}
          restore-keys: |
            tflint-${{ runner.os }}-

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: latest

      - name: Initialize TFLint
        run: tflint --init
        working-directory: ${{ inputs.working_directory }}

      - name: Run TFLint
        id: tflint
        continue-on-error: true
        working-directory: ${{ inputs.working_directory }}
        run: |
          mkdir -p ../../../security-reports
          # Run TFLint with JSON output
          tflint --format=json > ../../../security-reports/tflint-results.json 2>&1 || true
          # Run TFLint with SARIF output (if supported)
          tflint --format=sarif > ../../../security-reports/tflint-results.sarif 2>&1 || true
          # Also run for console output
          tflint --format=compact || true

      - name: Parse TFLint Results
        id: parse-tflint
        run: |
          if [ -f security-reports/tflint-results.json ]; then
            FINDINGS=$(jq 'if type == "array" then length else if has("issues") then .issues | length else 0 end end' security-reports/tflint-results.json 2>/dev/null || echo "0")
            echo "findings=${FINDINGS}" >> $GITHUB_OUTPUT
          else
            echo "findings=0" >> $GITHUB_OUTPUT
          fi

      # ========================================
      # Checkov Setup and Execution
      # ========================================
      - name: Cache Checkov
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: checkov-${{ runner.os }}-${{ hashFiles('.checkov.yaml') }}
          restore-keys: |
            checkov-${{ runner.os }}-

      - name: Setup Python for Checkov
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Checkov
        run: pip install checkov

      - name: Run Checkov
        id: checkov
        continue-on-error: true
        run: |
          mkdir -p security-reports
          checkov -d ${{ inputs.working_directory }} \
            --config-file .checkov.yaml \
            --output json \
            --output sarif \
            --output-file-path security-reports/ \
            || true

      - name: Parse Checkov Results
        id: parse-checkov
        run: |
          if [ -f security-reports/results_json.json ]; then
            PASSED=$(jq '.summary.passed // 0' security-reports/results_json.json 2>/dev/null || echo "0")
            FAILED=$(jq '.summary.failed // 0' security-reports/results_json.json 2>/dev/null || echo "0")
            SKIPPED=$(jq '.summary.skipped // 0' security-reports/results_json.json 2>/dev/null || echo "0")
            echo "passed=${PASSED}" >> $GITHUB_OUTPUT
            echo "failed=${FAILED}" >> $GITHUB_OUTPUT
            echo "skipped=${SKIPPED}" >> $GITHUB_OUTPUT
          else
            echo "passed=0" >> $GITHUB_OUTPUT
            echo "failed=0" >> $GITHUB_OUTPUT
            echo "skipped=0" >> $GITHUB_OUTPUT
          fi

      # ========================================
      # TFSec (Trivy) Setup and Execution
      # ========================================
      - name: Cache TFSec/Trivy
        uses: actions/cache@v4
        with:
          path: ~/.cache/trivy
          key: trivy-${{ runner.os }}-${{ hashFiles('.tfsec.yml') }}
          restore-keys: |
            trivy-${{ runner.os }}-

      - name: Run TFSec
        id: tfsec
        continue-on-error: true
        uses: aquasecurity/tfsec-action@v1.0.3
        with:
          working_directory: ${{ inputs.working_directory }}
          format: sarif,json
          sarif_file: security-reports/tfsec-results.sarif
          additional_args: --out security-reports/tfsec-results.json --config-file .tfsec.yml

      - name: Parse TFSec Results
        id: parse-tfsec
        run: |
          if [ -f security-reports/tfsec-results.json ]; then
            FINDINGS=$(jq '.results | length' security-reports/tfsec-results.json 2>/dev/null || echo "0")
            echo "findings=${FINDINGS}" >> $GITHUB_OUTPUT
          else
            echo "findings=0" >> $GITHUB_OUTPUT
          fi

      # ========================================
      # SARIF Upload to GitHub Security Tab
      # ========================================
      - name: Upload TFLint SARIF
        if: always() && hashFiles('security-reports/tflint-results.sarif') != ''
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: security-reports/tflint-results.sarif
          category: tflint-${{ inputs.environment_name }}
        continue-on-error: true

      - name: Upload Checkov SARIF
        if: always() && hashFiles('security-reports/results_sarif.sarif') != ''
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: security-reports/results_sarif.sarif
          category: checkov-${{ inputs.environment_name }}
        continue-on-error: true

      - name: Upload TFSec SARIF
        if: always() && hashFiles('security-reports/tfsec-results.sarif') != ''
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: security-reports/tfsec-results.sarif
          category: tfsec-${{ inputs.environment_name }}
        continue-on-error: true

      # ========================================
      # Archive Artifacts (SOC 2 Audit Trail)
      # ========================================
      - name: Upload Security Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-${{ inputs.environment_name }}-${{ github.sha }}
          path: security-reports/
          retention-days: ${{ inputs.artifact_retention_days }}

      # ========================================
      # Job Summary
      # ========================================
      - name: Security Scan Summary
        if: always()
        run: |
          echo "### Security Scan Summary - ${{ inputs.environment_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Tool | Status | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| TFLint | ${{ steps.tflint.outcome }} | ${{ steps.parse-tflint.outputs.findings }} findings |" >> $GITHUB_STEP_SUMMARY
          echo "| Checkov | ${{ steps.checkov.outcome }} | ${{ steps.parse-checkov.outputs.passed }} passed, ${{ steps.parse-checkov.outputs.failed }} failed, ${{ steps.parse-checkov.outputs.skipped }} skipped |" >> $GITHUB_STEP_SUMMARY
          echo "| TFSec | ${{ steps.tfsec.outcome }} | ${{ steps.parse-tfsec.outputs.findings }} findings |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Mode:** ${{ inputs.fail_on_findings && 'Hard fail' || 'Soft fail (warnings only)' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Artifacts retained for:** ${{ inputs.artifact_retention_days }} days" >> $GITHUB_STEP_SUMMARY

      # ========================================
      # Optional: Fail on Findings (Future)
      # ========================================
      - name: Check for Failures (Hard Fail Mode)
        if: inputs.fail_on_findings == true
        run: |
          if [[ "${{ steps.tflint.outcome }}" == "failure" ]] || \
             [[ "${{ steps.checkov.outcome }}" == "failure" ]] || \
             [[ "${{ steps.tfsec.outcome }}" == "failure" ]]; then
            echo "::error::Security scan found issues. Review the findings above."
            exit 1
          fi
